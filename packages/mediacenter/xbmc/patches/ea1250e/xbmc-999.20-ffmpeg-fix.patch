From 2a59f4438f790da4628bf3e80d4e243fc905399d Mon Sep 17 00:00:00 2001
From: FlyingRat <flyingrat@outlook.com>
Date: Wed, 24 Apr 2013 18:52:59 +0200
Subject: [PATCH] [@FFMPEGHEAD] tmp fix: redefined decrepated definitions

TODO: refactor all decrepated definitions (including warnings)
---
 lib/DllAvCodec.h                                        |  3 +++
 lib/DllAvFilter.h                                       | 17 ++++++++++++++---
 lib/ffmpeg/patches/0040-dxva2-configure.patch           | 15 +++++++++++++++
 xbmc/cores/dvdplayer/DVDAudio.h                         |  2 ++
 .../dvdplayer/DVDCodecs/Audio/DVDAudioCodecFFmpeg.cpp   |  2 ++
 .../cores/dvdplayer/DVDCodecs/Audio/DVDAudioCodecLPcm.h |  1 +
 .../dvdplayer/DVDCodecs/Audio/DVDAudioCodecPcm.cpp      |  2 ++
 .../dvdplayer/DVDCodecs/Video/DVDVideoCodecFFmpeg.cpp   |  2 ++
 xbmc/cores/dvdplayer/DVDDemuxers/DVDDemux.h             |  4 ++++
 9 files changed, 45 insertions(+), 3 deletions(-)
 create mode 100644 lib/ffmpeg/patches/0040-dxva2-configure.patch

diff --git a/lib/DllAvCodec.h b/lib/DllAvCodec.h
index 2b4ee22..64426b3 100644
--- a/lib/DllAvCodec.h
+++ b/lib/DllAvCodec.h
@@ -41,6 +41,9 @@
 #ifndef __GNUC__
 #pragma warning(disable:4244)
 #endif
+    
+#define CodecID AVCodecID       //@FFMPEGHEAD temp hack. TODO: name CodecID decrepated, rename to AVCodecID globaly...
+#define AVCODEC_MAX_AUDIO_FRAME_SIZE 192000 // 1 second of 48khz 32bit audio // @FFMPEGHEAD temp hack. TODO: repl w off ref.
 
 #if (defined USE_EXTERNAL_FFMPEG)
   #if (defined HAVE_LIBAVCODEC_AVCODEC_H)
diff --git a/lib/DllAvFilter.h b/lib/DllAvFilter.h
index d44b918..3c6c961 100644
--- a/lib/DllAvFilter.h
+++ b/lib/DllAvFilter.h
@@ -20,6 +20,10 @@
  *
  */
 
+// #define FF_API_AVFILTERBUFFER 1         // @FFMPEGHEAD temp hack
+// #define av_buffersrc_add_frame(ctx,frame) av_buffersrc_add_frame_flags(ctx, frame, 0);
+
+
 #if (defined HAVE_CONFIG_H) && (!defined WIN32)
   #include "config.h"
 #endif
@@ -56,6 +60,9 @@
   #include "libavfilter/buffersink.h"
   #include "libavfilter/avcodec.h"
 #endif
+
+#include "libavfilter/buffersrc.h"  // @FFMPEGHEAD temp hack
+    
 }
 
 #if LIBAVFILTER_VERSION_MICRO >= 100
@@ -83,7 +90,9 @@ class DllAvFilterInterface
   virtual int avfilter_graph_config(AVFilterGraph *graphctx, void *log_ctx)=0;
 #if (defined(LIBAVFILTER_FROM_LIBAV) && LIBAVFILTER_VERSION_INT >= AV_VERSION_INT(3,5,0)) || \
     (defined(LIBAVFILTER_FROM_FFMPEG) && LIBAVFILTER_VERSION_INT >= AV_VERSION_INT(3,43,100))
-  virtual int av_buffersrc_add_frame(AVFilterContext *buffer_filter, AVFrame *frame)=0;
+  virtual int av_buffersrc_add_frame(AVFilterContext *buffer_filter, AVFrame *frame)=0;                   // @FFMPEGHEAD temp hack
+//   virtual int av_buffersrc_add_frame_flags(AVFilterContext *buffer_filter, AVFrame *frame, int i=0)=0;    // @FFMPEGHEAD temp hack
+
 #elif defined(LIBAVFILTER_FROM_FFMPEG) && LIBAVFILTER_VERSION_INT >= AV_VERSION_INT(2,72,105)
   virtual int av_buffersrc_add_frame(AVFilterContext *buffer_filter, AVFrame *frame, int flags)=0;
 #else
@@ -146,9 +155,11 @@ class DllAvFilter : public DllDynamic, DllAvFilterInterface
   }
 #if (defined(LIBAVFILTER_FROM_LIBAV) && LIBAVFILTER_VERSION_INT >= AV_VERSION_INT(3,5,0)) || \
     (defined(LIBAVFILTER_FROM_FFMPEG) && LIBAVFILTER_VERSION_INT >= AV_VERSION_INT(3,43,100))
-  virtual int av_buffersrc_add_frame(AVFilterContext *buffer_filter, AVFrame* frame) { return ::av_buffersrc_add_frame(buffer_filter, frame); }
+  virtual int av_buffersrc_add_frame(AVFilterContext *buffer_filter, AVFrame* frame) {
+                                        return ::av_buffersrc_add_frame_flags(buffer_filter, frame, 0); } // @FFMPEGHEAD temp hack
 #elif defined(LIBAVFILTER_FROM_FFMPEG) && LIBAVFILTER_VERSION_INT >= AV_VERSION_INT(2,72,105)
-  virtual int av_buffersrc_add_frame(AVFilterContext *buffer_filter, AVFrame* frame, int flags) { return ::av_buffersrc_add_frame(buffer_filter, frame, flags); }
+  virtual int av_buffersrc_add_frame(AVFilterContext *buffer_filter, AVFrame* frame, int flags) {
+                                        return ::av_buffersrc_add_frame_flags(buffer_filter, frame, 0); } // @FFMPEGHEAD temp hack
 #else
   virtual int av_vsrc_buffer_add_frame(AVFilterContext *buffer_filter, AVFrame *frame, int flags) { return ::av_vsrc_buffer_add_frame(buffer_filter, frame, flags); }
 #endif
diff --git a/lib/ffmpeg/patches/0040-dxva2-configure.patch b/lib/ffmpeg/patches/0040-dxva2-configure.patch
new file mode 100644
index 0000000..845b322
--- /dev/null
+++ b/lib/ffmpeg/patches/0040-dxva2-configure.patch
@@ -0,0 +1,15 @@
+diff --git a/configure b/configure
+index f690db1..111f9fd 100755 (executable)
+--- a/configure
++++ b/configure
+@@ -1908,6 +1908,9 @@ enable safe_bitstream_reader
+ enable static
+ enable swscale_alpha
+ 
++# By default, enable only those hwaccels that have no external dependencies.
++enable dxva2 vdpau
++
+ # build settings
+ SHFLAGS='-shared -Wl,-soname,$$(@F)'
+ AVSERVERLDFLAGS=-Wl,-E
+
diff --git a/xbmc/cores/dvdplayer/DVDAudio.h b/xbmc/cores/dvdplayer/DVDAudio.h
index e76d443..ab32194 100644
--- a/xbmc/cores/dvdplayer/DVDAudio.h
+++ b/xbmc/cores/dvdplayer/DVDAudio.h
@@ -30,6 +30,8 @@
 #include "cores/AudioEngine/Utils/AEChannelInfo.h"
 class IAEStream;
 
+#define CodecID AVCodecID       //@FFMPEGHEAD temp hack. TODO: name CodecID decrepated, rename to AVCodecID globaly...
+
 extern "C" {
 #if (defined USE_EXTERNAL_FFMPEG)
   #if (defined HAVE_LIBAVCODEC_AVCODEC_H)
diff --git a/xbmc/cores/dvdplayer/DVDCodecs/Audio/DVDAudioCodecFFmpeg.cpp b/xbmc/cores/dvdplayer/DVDCodecs/Audio/DVDAudioCodecFFmpeg.cpp
index 80930a0..263e4d9 100644
--- a/xbmc/cores/dvdplayer/DVDCodecs/Audio/DVDAudioCodecFFmpeg.cpp
+++ b/xbmc/cores/dvdplayer/DVDCodecs/Audio/DVDAudioCodecFFmpeg.cpp
@@ -18,6 +18,8 @@
  *
  */
 
+// #define AVCODEC_MAX_AUDIO_FRAME_SIZE 192000 // 1 second of 48khz 32bit audio @FFMPEGHEAD
+
 #include "DVDAudioCodecFFmpeg.h"
 #ifdef _LINUX
 #include "XMemUtils.h"
diff --git a/xbmc/cores/dvdplayer/DVDCodecs/Audio/DVDAudioCodecLPcm.h b/xbmc/cores/dvdplayer/DVDCodecs/Audio/DVDAudioCodecLPcm.h
index cdfb90c..8b0d234 100644
--- a/xbmc/cores/dvdplayer/DVDCodecs/Audio/DVDAudioCodecLPcm.h
+++ b/xbmc/cores/dvdplayer/DVDCodecs/Audio/DVDAudioCodecLPcm.h
@@ -24,6 +24,7 @@
 #include "DVDCodecs/DVDCodecs.h"
 #include "DVDAudioCodecPcm.h"
 
+// #define AVCODEC_MAX_AUDIO_FRAME_SIZE 192000 // 1 second of 48khz 32bit audio // @FFMPEGHEAD temp hack
 #define LPCM_BUFFER_SIZE (AVCODEC_MAX_AUDIO_FRAME_SIZE / 2)
 
 class CDVDAudioCodecLPcm : public CDVDAudioCodecPcm
diff --git a/xbmc/cores/dvdplayer/DVDCodecs/Audio/DVDAudioCodecPcm.cpp b/xbmc/cores/dvdplayer/DVDCodecs/Audio/DVDAudioCodecPcm.cpp
index 1a8757e..2e944d7 100644
--- a/xbmc/cores/dvdplayer/DVDCodecs/Audio/DVDAudioCodecPcm.cpp
+++ b/xbmc/cores/dvdplayer/DVDCodecs/Audio/DVDAudioCodecPcm.cpp
@@ -18,6 +18,8 @@
  *
  */
 
+// #define AVCODEC_MAX_AUDIO_FRAME_SIZE 192000 // 1 second of 48khz 32bit audio // @FFMPEGHEAD temp hack
+
 #include "DVDAudioCodecPcm.h"
 #include "DVDStreamInfo.h"
 #include "DVDCodecs/DVDCodecs.h"
diff --git a/xbmc/cores/dvdplayer/DVDCodecs/Video/DVDVideoCodecFFmpeg.cpp b/xbmc/cores/dvdplayer/DVDCodecs/Video/DVDVideoCodecFFmpeg.cpp
index 6331722..3dc253e 100644
--- a/xbmc/cores/dvdplayer/DVDCodecs/Video/DVDVideoCodecFFmpeg.cpp
+++ b/xbmc/cores/dvdplayer/DVDCodecs/Video/DVDVideoCodecFFmpeg.cpp
@@ -18,6 +18,8 @@
  *
  */
 
+#define FF_API_AVFILTERBUFFER 1		// @FFMPEGHEAD temp hack
+
 #include "system.h"
 #if (defined HAVE_CONFIG_H) && (!defined WIN32)
   #include "config.h"
diff --git a/xbmc/cores/dvdplayer/DVDDemuxers/DVDDemux.h b/xbmc/cores/dvdplayer/DVDDemuxers/DVDDemux.h
index bdad65b..2b6bcd3 100644
--- a/xbmc/cores/dvdplayer/DVDDemuxers/DVDDemux.h
+++ b/xbmc/cores/dvdplayer/DVDDemuxers/DVDDemux.h
@@ -31,9 +31,13 @@
 #pragma warning(disable:4244)
 #endif
 
+// #define FF_API_CODEC_ID 1    //@FFMPEGHEAD
+#define CodecID AVCodecID       //@FFMPEGHEAD temp hack. TODO temp: enable FF_API_CODEC_ID, long term: rename all
+
 #if (defined HAVE_CONFIG_H) && (!defined WIN32)
   #include "config.h"
 #endif
+
 #ifndef _LINUX
 // enum CodecID; // auto defined when neccesary
 #include <libavcodec/avcodec.h>
-- 
1.8.1.6

